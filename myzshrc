#!/usr/bin/zsh

###  myzshrc

export EDITOR=code
export VISUAL=vim

export DROPBOX_PATH=$HOME/Dropbox/sync
export GOPATH=$HOME/dev
export PATH=$PATH:$GOPATH/bin
export PATH=$PATH:$HOME/.local/bin
export PATH=$PATH:/usr/local/opt/mysql-client/bin

has() {
	command -v "$1" >/dev/null 2>&1
}

if has yarn; then
	export PATH="$PATH:$(yarn global bin)"
fi

# sync HISTFILE
if [ -d "$DROPBOX_PATH" ]; then
	export HISTFILE=$DROPBOX_PATH/zhistory
fi

if [ -x /opt/homebrew/bin/brew ]; then
	eval "$(/opt/homebrew/bin/brew shellenv)"
elif [ -x /usr/local/bin/brew ]; then
	eval "$(/usr/local/bin/brew shellenv)"
elif has brew; then
	eval "$(brew shellenv)"
fi

if has brew; then
	export FPATH=$(brew --prefix)/share/zsh-completions:$FPATH

	autoload -Uz compinit
	compinit -u
fi

#### Custom

# mise(rtx)
if has mise; then
	eval "$(mise activate zsh)"
	# . <(mise completion zsh) && compdef _mise mise
fi

# Git
if has git; then
	alias gp="git pull"
	alias gpo="git pb"
	alias grpo="gm && gpo && git remote prune origin"
	alias gm='git checkout "$(git symbolic-ref refs/remotes/origin/HEAD | cut -d'/' -f4)"'
	alias gamend="git add . && git commit --amend --no-edit"
	alias gs="git status"
	alias gd="git diff --color-words"
	alias gc="git cleanup"
	alias gam="git commit -am"

	gss() {
		local idx=${1:-0}
		git stash show "stash@{$idx}" -p --color-words
	}

	if has git-wt; then
		eval "$(git wt --init zsh)"
	fi
fi

# kubernetes
if has kubectl; then
	# source <(kubectl completion zsh)
	alias k="kubectl"
	alias kg="k get"
	alias kgpo="kg pod"
	alias kl="kubetail"
	alias kc="kubectx"
	alias kn="kubens"

	autoload -U colors
	colors
	if has brew; then
		source "$(brew --prefix)/etc/zsh-kubectl-prompt/kubectl.zsh"
	fi
	# RPROMPT='%{$fg[blue]%}($ZSH_KUBECTL_PROMPT)%{$reset_color%}'

	if [ -d "$DROPBOX_PATH" ]; then
		export KUBECONFIG=$DROPBOX_PATH/kubeconfig
	fi
fi

if has k9s; then
	alias k9="k9s --readonly"
fi

export FZF_DEFAULT_OPTS='--height 60% --reverse --border'
# fzf inc search
function fzf-history-selection() {
	BUFFER=$(history -n 1 | tail -r | awk '!a[$0]++' |
		fzf --ansi \
			--preview-window=wrap \
			--preview='printf "%s\n" {} | bat --language=zsh --color=always --style=plain')
	CURSOR=$#BUFFER
	zle reset-prompt
}
zle -N fzf-history-selection
bindkey '^R' fzf-history-selection

# fzf ghq
function fzf-src() {
	local selected_dir=$(ghq list -p | fzf)
	if [ -n "$selected_dir" ]; then
		BUFFER="cd ${selected_dir}"
		zle accept-line
	fi
	zle clear-screen
}
zle -N fzf-src
bindkey '^]' fzf-src

if has thefuck; then
	eval "$(thefuck --alias)"
fi

if has direnv; then
	eval "$(direnv hook zsh)"
fi

if has tree; then
	alias t="tree -C"
fi

if has zoxide; then
	eval "$(zoxide init zsh)"
fi

# aqua https://aquaproj.github.io/
if has aqua; then
	export AQUA_GLOBAL_CONFIG=${AQUA_GLOBAL_CONFIG:-}:${XDG_CONFIG_HOME:-$HOME/.config}/aquaproj-aqua/aqua.yaml
	export PATH="$(aqua root-dir)/bin:$PATH"
fi

# rust
if [ -f $HOME/.cargo/env ]; then
	. "$HOME/.cargo/env"
fi

# gcloud
if has gcloud; then
	export PATH="$HOME/google-cloud-sdk/bin:$PATH"
	if has brew; then
		source "$(brew --prefix)/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/path.zsh.inc"
		source "$(brew --prefix)/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/completion.zsh.inc"
	fi
fi

# 1password
if has op; then
	eval "$(op completion zsh)"
	compdef _op op
fi

export GPG_TTY=$(tty)

# source local rc
if [ -f $DROPBOX_PATH/myzshrc_local ]; then
	source "$DROPBOX_PATH/myzshrc_local"
fi

### end of myzshrc
